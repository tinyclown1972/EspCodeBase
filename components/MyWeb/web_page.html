<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>猫猫喂水器</title>
    <style>
        body, html {
            height: 100%;
            margin: 0;
            font-family: 'Arial', sans-serif;
            background: #f7f7f7;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }
        .container {
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 500px;
            text-align: center;
        }
        .title {
            margin-bottom: 20px;
            color: #333;
        }
        .button {
            margin: 5px;
            padding: 10px 15px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            background: #5c67f2;
            color: white;
            width: calc(40% - 10px);
            font-size: 16px;
            transition: background 0.3s ease;
        }
        .button:hover {
            background: #4a54e1;
        }
        .button-orange {
            margin: 5px;
            padding: 10px 15px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            background: #ffa726;
            color: white;
            width: calc(40% - 10px);
            font-size: 16px;
            transition: background 0.3s ease;
        }
        .button-orange:hover {
            background: #ff9800;
        }
        .water-level {
            margin-bottom: 10px;
            color: #333;
        }
        .input-group {
            margin-bottom: 10px;
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: center;
        }
        input[type="number"] {
            margin: 5px;
            padding: 10px 20px;
            width: calc(40% - 10px);
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        input[type="number"]:focus {
            outline: none;
            border-color: #5c67f2;
        }
        @media (max-width: 600px) {
            .container {
                width: 90%;
            }
            input[type="number"] {
                width: calc(40% - 10px);
            }
        }
    </style>
</head>
<body>
<div class="container">
    <h1 class="title">猫猫喂水器</h1>
    <div class="water-level">
        <span>当前水位: </span>
        <span id="waterLevel">-</span>
    </div>
    <button class="button" style="margin-top: 20px" onclick="requestApi('PumpOn')">开始添水</button>
    <button class="button" style="margin-top: 20px" onclick="requestApi('PumpOff')">停止添水</button>

    <div class="input-group" style="margin-top: 20px">
        <input type="number" id="HighNumber" placeholder="High">
        <input type="number" id="LowNumber" placeholder="Low">
        <button class="button" style="width: calc(30% - 10px)" onclick="sendNumbersToApi()">确认</button>
    </div>

    <button class="button-orange" style="margin-top: 20px" onclick="sendPostRequest()">OTA</button>
    <button class="button-orange" style="margin-top: 20px" onclick="requestApi('Reboot')">设备重启</button>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 页面加载完成后立即开始请求水位API
        requestWaterLevelHigh();
        requestWaterLevelLow();
        requestWaterLevel();
        showAutoDismissAlert('欢迎!', 1000);

        function showAutoDismissAlert(message, duration = 3000) {
            // 创建一个提示元素
            const alertElement = document.createElement('div');
            alertElement.style.position = 'fixed';
            alertElement.style.top = '20px';
            alertElement.style.left = '50%';
            alertElement.style.transform = 'translateX(-50%)';
            alertElement.style.backgroundColor = '#f8d7da';
            alertElement.style.color = '#721c24';
            alertElement.style.padding = '10px';
            alertElement.style.borderRadius = '5px';
            alertElement.style.zIndex = '1000';
            alertElement.style.whiteSpace = 'nowrap';
            alertElement.textContent = message;

            // 将提示元素添加到页面中
            document.body.appendChild(alertElement);

            // 设置一个定时器来移除提示元素
            setTimeout(function() {
                document.body.removeChild(alertElement);
            }, duration);
        }

        // 定义一个函数来处理水位API请求
        function requestWaterLevel() {
            let isFirstTimeout = true; // 标记是否是第一次超时
            let isFirstGet = false; // 标记是否是第一次成功
            let firstTimeoutCount = 0;

            setInterval(function() {
                fetch('/api?cmd=waterLevel')
                    .then(response => {
                        if (response.ok) {
                            return response.json();
                        }
                        throw new Error('Network response was not ok.');
                    })
                    .then(data => {
                        document.getElementById('waterLevel').textContent = data.waterLevel; // 假设API返回的数据中有一个waterLevel属性
                        if ((isFirstTimeout === false) && (isFirstGet === true)) {
                            isFirstTimeout = true; // 重置标记
                            isFirstGet = false;
                            showAutoDismissAlert('设备上线,自动刷新页面', 1000);
                            window.location.reload(); // 超时后的第一次成功获取数据时刷新页面
                        }
                    })
                    .catch(error => {
                        if ((isFirstTimeout === true) && (isFirstGet === false)) { // 只有在第一次超时时弹窗
                            if(firstTimeoutCount === 2)
                            {
                                console.error('There has been a problem with your fetch operation:', error);
                                showAutoDismissAlert('请求超时，设备可能正在重启,或无法连接,请稍后再试。', 3000);
                                isFirstTimeout = false; // 标记已弹窗，不再弹窗
                                isFirstGet = true; //标记可以刷新
                                firstTimeoutCount = 0;
                            }
                            else
                            {
                                firstTimeoutCount++;
                            }
                        } else {
                            console.error('There has been a problem with your fetch operation:', error);
                        }
                    });
            }, 1000); // 1000毫秒，即1秒
        }

        function requestWaterLevelHigh() {
            fetch('/api?cmd=waterLevelHigh')
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    }
                    throw new Error('Network response was not ok.');
                })
                .then(data => {
                    document.getElementById('HighNumber').value = data.waterLevel; // 假设API返回的数据中有一个waterLevel属性
                })
                .catch(error => {
                    console.error('There has been a problem with your fetch operation:', error);
                });
        }

        function requestWaterLevelLow() {
            fetch('/api?cmd=waterLevelLow')
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    }
                    throw new Error('Network response was not ok.');
                })
                .then(data => {
                    document.getElementById('LowNumber').value = data.waterLevel; // 假设API返回的数据中有一个waterLevel属性
                })
                .catch(error => {
                    console.error('There has been a problem with your fetch operation:', error);
                });
        }
    });

    function validateAddress(address) {
        var pattern = /^http:\/\/.*\.bin$/i;
        return pattern.test(address);
    }

    function sendPostRequest() {
        var confirmed = confirm("您确定要进行OTA操作吗?");
        if (confirmed) {
            confirm("请使用python创建一个http的server服务器,并在其中放置待升级的固件,升级完成后会自动重启,失败则不会");
            var address = prompt("请输入完整地址: 如http://192.168.31.31:8070/EspCodeBase.bin");
            if (address !== null && address.trim() !== "") {
                if (validateAddress(address)) {
                    var xhr = new XMLHttpRequest();
                    var url = "ota";  // 替换为您的OTA API URL
                    xhr.open("POST", url, true);
                    xhr.setRequestHeader("Content-Type", "text/plain");

                    xhr.onreadystatechange = function () {
                        if (xhr.readyState === 4 && xhr.status === 200) {
                            var response = xhr.responseText;
                            console.log("OTA response:", response);
                            // 在这里处理OTA响应
                            alert("开始OTA,大约需要一分钟的时间,更新完成后会自动重启,请手动刷新页面");
                        }
                    };
                }
                else {
                    alert("地址输入有误,地址必须以http开始,bin结束");
                }
                xhr.send(encodeURIComponent(address));
            } else {
                alert("地址不能为空，请重新输入!");
            }
        }
    }

    function sendNumbersToApi() {
        var num1 = document.getElementById('HighNumber').value;
        var num2 = document.getElementById('LowNumber').value;
        var data = {
            High: parseFloat(num1),
            Low: parseFloat(num2)
        };
        console.log('Sending numbers to API:', data);
        // 实现发送请求到后端的逻辑，这里使用fetch API作为示例
        fetch('/waterlevel', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.text(); // 获取原始文本
            })
            .then(data => {
                if (data === "Ok") {
                    alert('设置成功, 重启以生效!');
                }
                else
                {
                    alert('非法输入，请检查输入值!');
                }
            })
            .catch((error) => {
                console.error('Error:', error);
            });
    }

    function requestApi(api) {
        const url = '/api?cmd=' + api;

        if(api === "Reboot")
        {
            var confirmed = confirm("确定要进行重启吗?");
            if(!confirmed)
            {
                return;
            }
        }

        // 使用fetch发送请求
        fetch(url)
            .then(response => {
                if (response.ok) {
                    return response.json(); // 如果响应是JSON格式
                }
                throw new Error('Network response was not ok.');
            })
            .then(data => {
                console.log(data); // 处理返回的数据
            })
            .catch(error => {
                console.error('There has been a problem with your fetch operation:', error);
            });
    }
</script>
</body>
</html>